/*
 * emagination.min.js
 */
!function(e){var t,a,i,o,r={AuthCode:"",ProductName:"",Prefix:"EmaginationJS-",APIUrl:"http://api.emaginationstore.com/v1.0/Personalisation",PreviewGuid:"",LoadInterval:800,FadeSpeed:400,ShowButtons:!0,EnableKeyboardNavigation:!0,PreviewImageWidth:800,ImageQuality:100,ImageFormat:"png",UseWatermark:!1,ResponseTracking:!1,LoadingMessage:'<img src="images/loading.gif" alt="" /><br /><br />Please Wait...',GenericError:"Personalisation could not be loaded",ControlsPlaceholder:'<h4>Step 1</h4><p>Select an Image or Textbox from the left hand side by clicking on it</p><br /><h4>Step 2</h4><p>Edit the area you have selected using the tools that will appear here.</p><br /><h4>Step 3</h4><p>See your personalised preview appear on the left hand side.</p><br /><p>Click <a href="#" class="EmaginationJS-Help">here</a> for help</p>',NoImagesText:"<p>Sorry, there are no images to display.</p>",DropzoneText:'<i class="fa fa-upload fa-fw"></i> Upload',NextButtonText:'<i class="fa fa-arrow-circle-right fa-2x"></i>',PreviousButtonText:'<i class="fa fa-arrow-circle-left fa-2x"></i>',HelpButtonText:'<i class="fa fa-question-circle"></i><span class="label">Help</span>',CloseHelpText:'<i class="fa fa-times-circle"></i><span class="label">Close Help</span>',PreviewButtonText:'<i class="fa fa-arrows-alt"></i><span class="label">Preview</span>',ResetButtonText:'<i class="fa fa-power-off"></i><span class="label">Reset</span>',CropWarning:'<i class="fa fa-warning fa-2x pull-left"></i> Please note the selected crop area is too small and may reduce the quality of the final print, to avoid this please upload a higher quality image or select a larger area.'},n={MainContainer:null,PreviewGuidInput:null,Personalisation:null,Controls:null,ButtonPanel:null,LoadingOverlay:null,LoadingMessage:null,Help:null,CanvasNavigation:null,NextButton:null,PreviousButton:null,CanvasContainer:null,Canvases:null,PreviewImages:null,CanvasElements:null,TextLayers:null,ImageLayers:null,HelpOverlay:null,CloseHelp:null,ToolTips:null,HelpButton:null,PreviewButton:null,ResetButton:null,ControlsTitles:null,ControlsToolTip:null,ControlsPlaceholder:null,TextControls:null,ImageControls:null,TextContent:null,CharacterCounter:null,LibraryImages:null,NoLibraryImages:null,LibraryImagesContainer:null,Dropzone:null,UploadImages:null,CropMessage:null},s=0,l=0,d={init:function(t){i=d.GetCookie(r.Prefix+r.ProductName.split(" ").join("-"));var a=this;n.MainContainer=a,r=e.extend(r,t),d.CreateStaticElements(a),d.SetStaticElementDefaults(),""==r.AuthCode&&d.Error("Please specify an Auth Code"),""==r.ProductName&&d.Error("Please specify a Product Name"),d.PopulateProduct();var o,u,p=d.GetCurrentDateTime(),v=setInterval(function(){if(s>0&&l==s&&(clearInterval(v),l=0,d.ShowPersonalisation(),r.ResponseTracking)){var t=d.GetCurrentDateTime();e.post(r.APIUrl+"/SubmitResponseTime",{start:p,finish:t,authcode:r.AuthCode,method:"Load",guid:i,imagewidth:n.CanvasContainer.width(),imagequality:r.ImageQuality,imagetype:r.ImageFormat},function(){},"jsonp")}},250);null!=n.CanvasContainer&&(u=n.CanvasContainer.width()),e(window).resize(function(){clearTimeout(o),null!=n.Canvases&&n.Canvases.each(function(){d.ResizeCanvas(e(this))}),d.ResizeLibraryContainer(),n.Controls.outerHeight(n.MainContainer.height()-n.ButtonPanel.outerHeight(!0)),void 0!=u?n.CanvasContainer.width()!=u&&(o=setTimeout(function(){n.LoadingOverlay.fadeIn(r.FadeSpeed),n.Canvases.each(function(){d.LoadPreviewImage(e(this),i)}),u=n.CanvasContainer.width()},500)):null!=n.CanvasContainer&&(u=n.CanvasContainer.width())})},CreateStaticElements:function(t){var a="";a=r.Prefix+"PreviewGuid",t.append('<input type="hidden" id="'+a+'" />'),n.PreviewGuidInput=e("#"+a),a=r.Prefix+"Personalisation",t.append('<div id="'+a+'"></div>'),n.Personalisation=e("#"+a),a=r.Prefix+"ButtonPanel",t.append('<div id="'+a+'"></div>'),n.ButtonPanel=e("#"+a),a=r.Prefix+"Controls",t.append('<div id="'+a+'"></div>'),n.Controls=e("#"+a),a=r.Prefix+"LoadingOverlay",n.Personalisation.append('<div id="'+a+'"></div>'),n.LoadingOverlay=e("#"+a),a=r.Prefix+"HelpOverlay",n.MainContainer.after('<div id="'+a+'"></div>'),n.HelpOverlay=e("#"+a),a=r.Prefix+"CloseHelp",n.HelpOverlay.append('<a id="'+a+'" title="Close"></a>'),n.CloseHelp=e("#"+a),a=r.Prefix+"LoadingMessage",n.LoadingOverlay.append('<div class="'+a+'">'+r.LoadingMessage+"</div>"),n.LoadingMessage=e("."+a),r.ShowCanvasNavigation&&(a=r.Prefix+"CanvasNavigation",n.Personalisation.append('<div id="'+a+'"></div>'),n.CanvasNavigation=e("#"+a)),r.ShowButtons&&(a=r.Prefix+"Next",n.Personalisation.append('<div class="'+a+'">'+r.NextButtonText+"</div>"),a=r.Prefix+"Previous",n.Personalisation.append('<div class="'+a+'">'+r.PreviousButtonText+"</div>")),n.NextButton=e("."+r.Prefix+"Next"),n.PreviousButton=e("."+r.Prefix+"Previous"),a=r.Prefix+"CanvasContainer",n.Personalisation.append('<div id="'+a+'"></div>'),n.CanvasContainer=e("#"+a);var i=r.Prefix+"Button";a=r.Prefix+"HelpButton",n.ButtonPanel.append('<a href="#" title="Help" id="'+a+'" class="'+i+'">'+r.HelpButtonText+"</a>"),n.HelpButton=e("#"+a),a=r.Prefix+"PreviewButton",n.ButtonPanel.append('<a href="#" title="Full Screen" id="'+a+'" class="'+i+'">'+r.PreviewButtonText+"</a>"),n.PreviewButton=e("#"+a),a=r.Prefix+"ResetButton",n.ButtonPanel.append('<a href="#" title="Reset" id="'+a+'" class="'+i+'">'+r.ResetButtonText+"</a>"),n.ResetButton=e("#"+a),a=r.Prefix+"ControlsToolTip",n.Controls.append('<div id="'+a+'"></div>'),n.ControlsToolTip=e("#"+a),n.ControlsToolTip.addClass(r.Prefix+"ToolTip"),a=r.Prefix+"ControlsPlaceholder",n.Controls.append('<div id="'+a+'">'+r.ControlsPlaceholder+"</div>"),n.ControlsPlaceholder=e("#"+a),a=r.Prefix+"TextControls",n.Controls.append('<div id="'+a+'"><span class="'+r.Prefix+'ControlsTitle">Edit your text</span></div>'),n.TextControls=e("#"+a),a=r.Prefix+"TextContent",n.TextControls.append('<form onsubmit="return false;"><input type="text" id="'+a+'" autocomplete="off" /></form>'),n.TextContent=e("#"+a),a=r.Prefix+"CharacterCounter",n.TextControls.append('<span id="'+a+'"></span>'),n.CharacterCounter=e("#"+a),a=r.Prefix+"ImageControls",n.Controls.append('<div id="'+a+'"><span class="'+r.Prefix+'ControlsTitle">Choose an image</span></div>'),n.ImageControls=e("#"+a),a=r.Prefix+"Dropzone",n.ImageControls.append('<div id="'+a+'">'+r.DropzoneText+"</div>"),n.Dropzone=e("#"+a),a=r.Prefix+"LibraryImagesContainer",n.ImageControls.append('<div id="'+a+'"></div>'),n.LibraryImagesContainer=e("#"+a),a=r.Prefix+"NoImages",n.LibraryImagesContainer.append('<div id="'+a+'">'+r.NoImagesText+"</div>"),n.NoLibraryImages=e("#"+a)},SetStaticElementDefaults:function(){function e(){n.LoadingMessage.height(n.LoadingMessage.height()),n.LoadingMessage.css({display:"block",width:"100%","text-align":"center",margin:"auto",position:"absolute",top:0,right:0,left:0,bottom:0})}n.MainContainer.add(n.Personalisation).add(n.Controls).add(n.TextContent).add(n.CanvasContainer).css({"-webkit-box-sizing":"border-box","-moz-box-sizing":"border-box","box-sizing":"border-box"}),n.MainContainer.css({position:"relative",clear:"both",overflow:"hidden"}),n.Personalisation.css({position:"relative",height:"100%"});var t=parseFloat(d.GetCSSValue(n.Controls,"margin-top"))+parseFloat(d.GetCSSValue(n.Controls,"margin-bottom"));if(n.Controls.css({position:"relative",height:n.MainContainer.height()-n.ButtonPanel.outerHeight(!0)-t+"px","box-sizing":"border-box","-moz-box-sizing":"border-box","-wekbit-box-sizing":"border-box"}),n.CanvasContainer.css({width:"100%",height:"100%",position:"relative",visibility:"hidden"}),n.TextContent.css("width","100%"),n.CharacterCounter.hide(),n.ImageControls.add(n.TextControls).add(n.ControlsPlaceholder).css({width:"100%",height:"100%"}).hide(),n.TextControls.add(n.ControlsPlaceholder).css({"overflow-y":"auto"}),null!=n.Dropzone&&n.Dropzone.css({cursor:"pointer"}),r.ShowHelpButton&&n.HelpButton.css({cursor:"pointer"}),n.HelpOverlay.hide().css({position:"fixed",top:0,left:0,width:"100%",height:"100%"}),n.CloseHelp.css({cursor:"pointer",display:"block"}),n.HelpButton.add(n.PreviewButton).css({cursor:"pointer"}),r.ShowCanvasNavigation&&n.CanvasNavigation.css({position:"absolute",top:"0",left:"0"}).hide(),r.ShowButtons){var a=n.Personalisation.find(n.NextButton),i=n.Personalisation.find(n.PreviousButton);a.css({position:"absolute",cursor:"pointer"}),i.css({position:"absolute",cursor:"pointer"})}null!=n.NextButton&&n.NextButton.hide(),null!=n.PreviousButton&&n.PreviousButton.hide(),n.ControlsPlaceholder.show(),n.ControlsToolTip.css({position:"absolute",display:"none"}),n.LoadingOverlay.css({position:"absolute",top:0,left:0,"z-index":999,width:"100%",height:"100%",display:"block"}),n.LoadingMessage.find("img").length>0?n.LoadingMessage.find("img").load(function(){e()}).error(function(){e()}):e(),0==n.MainContainer.height()&&(n.Personalisation.outerHeight(!0)>n.Controls.outerHeight(!0)?n.MainContainer.height(n.Personalisation.outerHeight(!0)):n.MainContainer.height(n.Controls.outerHeight(!0))),n.LibraryImagesContainer.css({overflow:"hidden","overflow-y":"scroll",height:"100%","box-sizing":"border-box","-moz-box-sizing":"border-box","-webkit-box-sizing":"border-box"})},PopulateProduct:function(){var t=[];i=d.GetCookie(r.Prefix+r.ProductName.split(" ").join("-")),""!=r.PreviewGuid&&(i=r.PreviewGuid),n.PreviewGuidInput.val(i),""===i||null===i?e.post(r.APIUrl+"/CreateNewPreview",{authcode:r.AuthCode,productname:r.ProductName},function(a){var o=d.GetAJAXError(a);if(""==o){i=a.objResult.GUID,n.PreviewGuidInput.val(i),d.SetCookie(r.Prefix+r.ProductName.split(" ").join("-"),i,1);var l=a.objResult.product.ProductTemplates;s=l.length,e.each(l,function(e,a){t.push(d.CreateCanvas(e,a))})}else d.Error(o)},"jsonp").error(function(e,t,a){d.Error(a)}):e.post(r.APIUrl+"/GetPreviewData",{authcode:r.AuthCode,guid:i},function(a){var o=d.GetAJAXError(a);if(""==o){var n=a.objResult.product.ProductTemplates;s=n.length,e.each(n,function(e,a){t.push(d.CreateCanvas(e,a))})}else e.post(r.APIUrl+"/CreateNewPreview",{authcode:r.AuthCode,productname:r.ProductName},function(a){var o=d.GetAJAXError(a);if(""==o){i=a.objResult.GUID,""==r.PreviewGuid&&d.SetCookie(r.Prefix+r.ProductName.split(" ").join("-"),i,1);var n=a.objResult.product.ProductTemplates;s=n.length,e.each(n,function(e,a){t.push(d.CreateCanvas(e,a))})}else d.Error(o)},"jsonp").error(function(e,t,a){d.Error(a)})},"jsonp").error(function(e,t,a){d.Error(a)})},CreateCanvas:function(t,a){var o=r.Prefix+"set-"+t;n.CanvasContainer.append('<div id="'+o+'" class="'+r.Prefix+'Canvas" data-set-name="'+a.TemplateName+'" data-template-width="'+a.Width+'" data-template-height="'+a.Height+'"></div>');var s=e("#"+o);""!=a.Alias&&s.attr("data-alias",a.Alias);var u=1,p=a.Width,v=a.Height;return u=n.CanvasContainer.width()/p,p=Math.round(p*u),v=Math.round(v*u),s.css({position:"absolute",top:0,left:0,"box-sizing":"border-box","-moz-box-sizing":"border-box","-webkit-box-sizing":"border-box",width:p,height:v}),e.post(r.APIUrl+"/GetPreviewImage",{authcode:r.AuthCode,guid:i,templatename:a.TemplateName,imagewidth:Math.round(n.CanvasContainer.width()),previewwatermark:r.UseWatermark,imagequality:r.ImageQuality,imagetype:r.ImageFormat},function(t){var i=d.GetAJAXError(t);if(""==i){var n=[];e.each(a.Layers,function(e,t){n.push(d.CreateCanvasLayer(o,t))}),e.each(n,function(e,t){s.append(t)});var u=new Image;e(u).addClass(r.Prefix+"PreviewImage"),u.onload=function(){l++},u.src=t.objResult,s.append(u)}else d.Error(i)},"jsonp").error(function(e,t,a){d.Error(a)}),s},CreateCanvasLayer:function(t,a){var i=t+"-"+a.LayerName,o=e('<div id="'+i+'" data-layer-name="'+a.LayerName+'" data-width="'+a.Width+'" data-height="'+a.Height+'" data-x="'+a.X+'" data-y="'+a.Y+'" class="'+r.Prefix+a.LayerType+" "+r.Prefix+'Element"></div>');""!=a.Alias&&o.attr("data-alias",a.Alias),e("#"+t).append(o),o.attr("data-layer-data",a.LayerData);var s=Math.cos(a.Rotate),l=Math.sin(a.Rotate),u=e('<div class="'+r.Prefix+'Inner" style="width:100%; height:100%; font-size:999px; color:transparent; overflow:hidden; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box;">Internet Explorer</div>');if(o.append(u),o.css({position:"absolute",width:a.Width,height:a.Height,left:a.X,top:a.Y,cursor:"pointer","z-index":"1"}),0!=a.Rotate&&o.css({"-ms-transform":"Rotate("+a.Rotate+"deg)","-moz-transform":"Rotate("+a.Rotate+"deg)","-o-transform":"Rotate("+a.Rotate+"deg)","-webkit-transform":"Rotate("+a.Rotate+"deg)",transform:"Rotate("+a.Rotate+"deg)","-ms-filter":'"progid:DXImageTransform.Microsoft.Matrix(M11='+s+", M12="+-l+", M21="+l+", M22="+s+", sizingMethod='auto expand')\";"}),"TextLayer"==a.LayerType&&null!=a.CharacterLimit&&o.attr("data-character-limit",a.CharacterLimit),"ImageLayer"==a.LayerType&&(o.attr("data-allow-upload",a.allowUserUploads),a.ImageLibrary.length>0))for(var p=0;p<a.ImageLibrary.length;p++){var v=a.ImageLibrary[p],c=r.Prefix+"LibraryImage-"+a.LayerName+"-"+p;n.LibraryImagesContainer.append('<img id="'+c+'" src="'+v.ThumbnailUrl+'" data-url="'+v.Url.toLowerCase()+'" alt="" class="'+r.Prefix+'LibraryImage" data-layer-id="'+i+'" data-layer-name="'+a.LayerName+'" style="max-width: 100%; cursor: pointer;" />')}o.attr("data-help-text",a.HelpText);var h=e('<a title="Close Help" class="'+r.Prefix+'CloseToolTip"><i class="fa fa-times"></i></a>'),f=e('<div class="'+r.Prefix+'ToolTip">'+a.HelpText+"</div>");return f.click(function(t){t.preventDefault(),t.stopPropagation(),e(this).hide(),0==n.Personalisation.find(n.ToolTips.filter(":visible")).length&&d.CloseHelp()}),f.attr("data-layer-id",i),f.attr("data-x",a.X),f.attr("data-y",a.Y),f.css({position:"absolute","z-index":parseFloat(o.css("z-index"))+1,cursor:"pointer",display:"none"}),f.prepend(h),f},ShowPersonalisation:function(){n.ControlsTitles=e("."+r.Prefix+"ControlsTitle"),n.Canvases=e("."+r.Prefix+"Canvas"),n.PreviewImages=e("."+r.Prefix+"PreviewImage"),n.CanvasElements=e("."+r.Prefix+"Element"),n.TextLayers=e("."+r.Prefix+"TextLayer"),n.ImageLayers=e("."+r.Prefix+"ImageLayer"),n.LibraryImages=e("."+r.Prefix+"LibraryImage"),n.Help=e("."+r.Prefix+"Help"),n.ToolTips=e("."+r.Prefix+"ToolTip"),d.BindNavButtons(),d.BindUploads(),d.BindEvents(),n.Canvases.each(function(){d.ResizeCanvas(e(this))}),null!=n.CanvasNavigation&&n.CanvasNavigation.fadeIn(r.FadeSpeed),null!=n.PreviousButton&&n.PreviousButton.hide(),n.Canvases.length>1?null!=n.NextButton&&n.NextButton.show():null!=n.PreviousButton&&n.PreviousButton.hide(),d.SelectCanvas(n.Canvases.first())},BindUploads:function(){try{var t=null;n.Dropzone.dropzone({url:r.APIUrl+"/SaveImageToLibrary",addRemoveLinks:!1,maxFilesize:12,maxFiles:1,dictMaxFilesExceeded:"Please upload 1 file at a time.",uploadMultiple:!1,init:function(){t=this},accept:function(e,t){n.Dropzone.attr("disabled")?t("Please upload 1 file at a time."):t()},forceFallback:!1,fallback:function(){n.Dropzone.remove(),n.Dropzone=null},sending:function(e,t,a){n.Dropzone.attr("disabled","disabled"),d.ResizeLibraryContainer(),a.append("authcode",r.AuthCode),a.append("previewGuid",i),a.append("setname",n.ImageLayers.filter(".active").parents(n.Canvases).attr("data-set-name")),a.append("layername",n.ImageLayers.filter(".active").attr("data-layer-name")),d.CloseHelp()},success:function(a,o){var s=d.GetAJAXError(o);if(""==s){var l=n.ImageLayers.filter(".active").attr("data-layer-name"),u=n.ImageLayers.filter(".active").attr("id"),p=e('<img src="'+o.objResult[0].ThumbnailUrl+'" data-url="'+o.objResult[0].Url+'" alt="" class="'+r.Prefix+'LibraryImage" data-layer-id="'+u+'" data-layer-name="'+l+'" style="max-width: 100%; cursor: pointer; display: none;" />');if(t.removeFile(a),0===t.getUploadingFiles().length&&0===t.getQueuedFiles().length){e.fancybox.showLoading(),d.ResizeLibraryContainer();var v=e('<div id="'+r.Prefix+'PhotoEditor"><h3>Edit your image</h3></div>'),c=new Image,h=n.ImageLayers.filter(":visible.active"),f=h.attr("data-width"),g=h.attr("data-height"),C=e('<a class="'+r.Prefix+'CropButton" href="#" title="Save">Save</a>'),m=e('<a class="'+r.Prefix+'CropButton" href="#" title="Cancel">Cancel</a>'),x=e('<div class="'+r.Prefix+'CropWarning">'+r.CropWarning+"</div>"),b=!1;c.onload=function(){function t(t){l.css({clear:"both"});var a=e(window).height()-400,i=r.PreviewImageWidth,o=200,n=200,s=l.width(),d=l.height(),u=e(window).width()-100,p=a;if(n>u||o>p)p>u?(l.width(n),l.height("auto")):(l.height(o),l.width("auto"));else{if(y>i||P>a)if(y>=P)i>u?(l.width(u),l.height("auto")):(l.width(i),l.height("auto")),l.height()>a&&(l.width("auto"),l.height(a));else{var c=p/l.height(),C=l.width()*c;C>u?(l.height("auto"),l.width(u)):(l.height(p),l.width("auto"))}(n>y||o>P)&&(y>P?(l.width("auto"),l.height(o)):(l.width(n),l.height("auto")))}s=l.width(),d=l.height(),h=s/y,v.css("visibility","visible"),v.width(s),v.height("auto");var m=g,x=f;if(y>P){var b=20*(P/100);m=P-b,x=f/g*m}else{var b=20*(y/100);x=y-b,m=g/f*x}w=y/2-x/2,T=P/2-m/2,I=y/2+x/2,L=P/2+m/2,e.fancybox.update(),void 0!=t&&t()}function a(){function t(t){var a=!1;l.attr("data-x",t.x),l.attr("data-y",t.y),l.attr("data-w",t.w),l.attr("data-h",t.h),l.attr("data-scale",h),t.w<f&&(a=!0),t.h<g&&(a=!0),a?x.show():x.hide(),e.fancybox.update()}d.isIE?s=e.Jcrop(l,{setSelect:[w,T,I,L],bgOpacity:.5,allowSelect:!1,aspectRatio:f/g,trueSize:[y,P],boxWidth:l.width(),boxHeight:l.height(),bgColor:"#eeeeee",onSelect:function(e){t(e)},onChange:function(e){t(e)},onRelease:function(e){t(e)}}):l.Jcrop({setSelect:[w,T,I,L],bgOpacity:.5,allowSelect:!1,aspectRatio:f/g,trueSize:[y,P],boxWidth:l.width(),boxHeight:l.height(),bgColor:"#eeeeee",onSelect:function(e){t(e)},onChange:function(e){t(e)},onRelease:function(e){t(e)}},function(){s=this})}c.onload=null;var s,l=e("."+r.Prefix+"PhotoCrop"),h=1,y=l.width(),P=l.height(),w=0,T=0,I=0,L=0;t(function(){e.fancybox(v,{type:"inline",scrolling:"visible",openSpeed:r.FadeSpeed,autoSize:!0,autoCenter:!1,fitToView:!1,autoResize:!1,minWidth:50,minHeight:50,maxWidth:r.PreviewImageWidth,helpers:{overlay:{closeClick:!1}},afterClose:function(){n.Dropzone.removeAttr("disabled"),v.remove()}}),a()}),C.click(function(t){if(t.preventDefault(),!b){b=!0;var a=(parseFloat(l.attr("data-scale")),Math.round(parseFloat(l.attr("data-x")))),s=Math.round(parseFloat(l.attr("data-y"))),v=Math.round(parseFloat(l.attr("data-w"))),c=Math.round(parseFloat(l.attr("data-h")));e.post(r.APIUrl+"/CropImage",{authcode:r.AuthCode,previewguid:i,url:o.objResult[0].Url,x:a,y:s,width:v,height:c},function(t){b=!1;var a=d.GetAJAXError(t);""==a?(p.attr("src",t.objResult.ThumbnailUrl),p.attr("data-url",t.objResult.Url),e.fancybox.close(),n.Dropzone.removeAttr("disabled"),n.NoLibraryImages.after(p),d.BindLibraryImageClick(p),n.LibraryImages=e("."+r.Prefix+"LibraryImage"),n.NoLibraryImages.hide(),d.FormatLibraryImages(n.LibraryImages.filter("[data-layer-id="+u+"]").show()),p.trigger("mousedown")):(alert("Error: Image cannot be cropped."),console.log("Error: "+a))},"jsonp")}}),m.click(function(){e.fancybox.close(),n.Dropzone.removeAttr("disabled")})},c.src=o.objResult[0].Url,c.className=r.Prefix+"PhotoCrop",v.append(c),v.append(x.hide()),v.append(C),v.append(m),v.append('<div style="width:100%; clear: both; height:0px; overflow:hidden;"></div>'),e(document.body).css("overflow","visible").append(v.css({width:"1px",height:"1px",overflow:"hidden",visibility:"hidden"}))}}else alert(s),t.removeFile(a),n.LoadingOverlay.fadeOut(r.FadeSpeed),d.ResizeLibraryContainer(),n.Dropzone.removeAttr("disabled")},error:function(e,a){alert(a),t.removeFile(e),n.LoadingOverlay.fadeOut(r.FadeSpeed),d.ResizeLibraryContainer(),n.Dropzone.removeAttr("disabled")}})}catch(a){try{n.Dropzone.remove(),n.Dropzone=null}catch(a){}}},ResizeCanvas:function(t){var a=1,i=parseFloat(t.attr("data-template-height")),o=parseFloat(t.attr("data-template-width"));ResizeByHeight=function(){a=n.CanvasContainer.height()/i;var e=o*a,r=i*a;t.css({height:r+"px",width:e+"px",left:Math.round((n.Personalisation.width()-e)/2),top:0}),t.find(n.PreviewImages).css({width:"100%",height:"100%","box-sizing":"border-box","-moz-box-sizing":"border-box","-webkit-box-sizing":"border-box"})},ResizeByWidth=function(){a=n.CanvasContainer.width()/o;var e=o*a,r=i*a;t.css({height:r+"px",width:e+"px",top:Math.round((n.Personalisation.height()-r)/2),left:0}),t.find(n.PreviewImages).css({height:"100%",width:"100%","box-sizing":"border-box","-moz-box-sizing":"border-box","-webkit-box-sizing":"border-box"})},ResizeByWidth(),t.height()>n.CanvasContainer.height()&&ResizeByHeight(),t.attr("data-scale-factor",a),t.find(n.CanvasElements).each(function(){var t=e(this),i=parseFloat(t.attr("data-width")),o=parseFloat(t.attr("data-height")),r=parseFloat(t.attr("data-y")),n=parseFloat(t.attr("data-x"));i*=a,o*=a,r*=a,n*=a;var s=parseFloat(d.GetCSSValue(t,"border-right-width")),l=parseFloat(d.GetCSSValue(t,"border-left-width")),u=parseFloat(d.GetCSSValue(t,"border-top-width")),p=parseFloat(d.GetCSSValue(t,"border-bottom-width"));i-=s,o-=p,n-=l,r-=u,t.css({width:i,height:o,left:n,top:r})}),d.RepositionTooltips(t,a),d.RepositionControlsTooltip();var r=n.Personalisation.find(n.NextButton),s=n.Personalisation.find(n.PreviousButton),l=r.css("top"),u=s.css("top");r.css("right"),s.css("left"),l=(n.Personalisation.outerHeight()-r.outerHeight())/2,u=(n.Personalisation.outerHeight()-s.outerHeight())/2,r.css({top:l}),s.css({top:u})},SelectCanvas:function(e){if(e.length>0){n.Canvases.hide(),e.stop(!0,!0).fadeIn(r.FadeSpeed);var t=n.Canvases.length;null!=n.NextButton&&null!=n.PreviousButton&&(n.NextButton.show(),n.PreviousButton.show(),t>1?(0==n.Canvases.filter(":visible:first").index()&&n.PreviousButton.hide(),n.Canvases.filter(":visible:first").index()==t-1&&n.NextButton.hide()):(n.NextButton.hide(),n.PreviousButton.hide())),n.LoadingOverlay.fadeOut(r.FadeSpeed),n.CanvasContainer.css("visibility","visible"),d.CloseHelp()}},BindNavButtons:function(){null!=n.NextButton&&n.NextButton.click(function(e){if(e.preventDefault(),!n.LoadingOverlay.is(":visible"))if(n.HelpOverlay.is(":visible"))d.CloseHelp(function(){var e=n.Canvases.filter(":visible:first").next(n.Canvases);d.CloseControls(),d.SelectCanvas(e),d.RepositionTooltips(e)});else{var t=n.Canvases.filter(":visible:first").next(n.Canvases);d.CloseControls(),d.SelectCanvas(t),d.RepositionTooltips(t)}}),null!=n.PreviousButton&&n.PreviousButton.click(function(e){if(e.preventDefault(),!n.LoadingOverlay.is(":visible"))if(n.HelpOverlay.is(":visible"))d.CloseHelp(function(){var e=n.Canvases.filter(":visible:first").prev(n.Canvases);d.CloseControls(),d.SelectCanvas(e),d.RepositionTooltips(e)});else{var t=n.Canvases.filter(":visible:first").prev(n.Canvases);d.CloseControls(),d.SelectCanvas(t),d.RepositionTooltips(t)}}),r.EnableKeyboardNavigation&&e(document).keydown(function(t){if(0==e(t.target).is("input, textarea"))if(37==t.keyCode){if(t.preventDefault(),!n.LoadingOverlay.is(":visible"))if(n.HelpOverlay.is(":visible"))d.CloseHelp(function(){var e=n.Canvases.filter(":visible:first").prev(n.Canvases);d.CloseControls(),d.SelectCanvas(e),d.RepositionTooltips(e)});else{var a=n.Canvases.filter(":visible:first").prev(n.Canvases);d.CloseControls(),d.SelectCanvas(a),d.RepositionTooltips(a)}}else if(39==t.keyCode&&(t.preventDefault(),!n.LoadingOverlay.is(":visible")))if(n.HelpOverlay.is(":visible"))d.CloseHelp(function(){var e=n.Canvases.filter(":visible:first").next(n.Canvases);d.CloseControls(),d.SelectCanvas(e),d.RepositionTooltips(e)});else{var a=n.Canvases.filter(":visible:first").next(n.Canvases);d.CloseControls(),d.SelectCanvas(a),d.RepositionTooltips(a)}})},BindEvents:function(){n.ImageLayers.each(function(){var t=e(this);t.mousedown(function(){d.CloseControls(),t.addClass("active").css("z-index","0");var a=n.LibraryImages.removeClass("active").hide().filter("[data-layer-id="+t.attr("id")+"]"),i=e("#"+a.first().attr("data-layer-id"));a.length>0?(n.NoLibraryImages.hide(),a.filter('[data-url="'+i.attr("data-layer-data").toLowerCase()+'"]').show().first().addClass("active"),d.FormatLibraryImages(a),n.ImageControls.show()):(n.NoLibraryImages.show(),n.ImageControls.show()),"true"==t.attr("data-allow-upload")&&null!=n.Dropzone&&n.Dropzone.show();var o=t.attr("data-alias");n.ControlsToolTip.text("Choose an image to use here"),o&&n.ImageControls.find(n.ControlsTitles).text("Choose "+d.FormatArticle(o)+" "+o),n.HelpOverlay.is(":visible")&&n.HelpOverlay.is(":animated")===!1&&n.ControlsToolTip.fadeIn(r.FadeSpeed),n.ControlsPlaceholder.hide(),d.ResizeLibraryContainer(),d.RepositionControlsTooltip()})}),n.TextLayers.each(function(){var t=e(this);t.mousedown(function(){d.CloseControls(),n.TextContent.attr("data-layer-name",t.attr("data-layer-name")),n.TextContent.val(t.attr("data-layer-data")),n.ControlsToolTip.text("Change your text here");var e=t.attr("data-alias");if(e&&n.TextControls.find(n.ControlsTitles).text("Edit your "+e),n.HelpOverlay.is(":visible")&&n.HelpOverlay.is(":animated")===!1&&n.ControlsToolTip.fadeIn(r.FadeSpeed),t.attr("data-character-limit")){var a=parseFloat(t.attr("data-character-limit"));if(a>0){var i=a-n.TextContent.val().length;0==i&&n.CharacterCounter.addClass("limit"),n.CharacterCounter.text(i+" character"+(1==i?"":"s")+" remaining").show()}}t.addClass("active").css("z-index","0"),n.TextControls.show(),n.ControlsPlaceholder.hide(),d.RepositionControlsTooltip()})}),n.LibraryImages.each(function(){d.BindLibraryImageClick(e(this))}),n.TextContent.on("keydown",function(){o=n.TextContent.val().length}),n.TextContent.on("keyup paste",function(a){function s(){n.LoadingOverlay.fadeIn(r.FadeSpeed);var a=n.TextLayers.filter("[data-layer-name="+l.attr("data-layer-name")+"]"),o=a.attr("data-layer-data");clearTimeout(t),t=setTimeout(function(){var t=n.Canvases.filter(":visible:first"),s=l.val();e.post(r.APIUrl+"/UpdateLayerInPreview",{authcode:r.AuthCode,guid:i,templatename:t.attr("data-set-name"),layername:l.attr("data-layer-name"),layerdata:s},function(s){n.LoadingOverlay.fadeIn(r.FadeSpeed);var u=d.GetAJAXError(s);""==u?(a.attr("data-layer-data",l.val()),d.LoadPreviewImage(t,i,function(){a.attr("data-layer-data",o),l.val(o)})):(a.attr("data-layer-data",o),l.val(o),n.LoadingOverlay.fadeOut(r.FadeSpeed),alert("Layer could not be updated"),e.error(u))},"jsonp").error(function(t,i,s){a.attr("data-layer-data",o),l.val(o),n.LoadingOverlay.fadeOut(r.FadeSpeed),alert(s),e.error(s)})},r.LoadInterval)}var l=e(this);if(13==a.keyCode)a.preventDefault(),n.TextContent.blur();else if(n.TextContent.val().length!==o){var u=n.TextLayers.filter(".active:visible");if(u.attr("data-character-limit")){var p=parseFloat(u.attr("data-character-limit"));l.val().length>p?l.val(l.val().substring(0,p)):s();var v=p-l.val().length;0==v?n.CharacterCounter.addClass("limit"):n.CharacterCounter.removeClass("limit"),n.CharacterCounter.text(v+" character"+(1==v?"":"s")+" remaining")}else s()}}),n.Help.add(n.HelpButton).click(function(t){t.preventDefault(),e("#fancybox-loading").is(":visible")||e(".fancybox-overlay").is(":visible")||(n.HelpOverlay.is(":visible")?d.CloseHelp():(n.HelpOverlay.fadeIn(r.FadeSpeed),n.HelpButton.attr("title","Close Help"),n.ToolTips.not(n.ControlsToolTip).fadeIn(r.FadeSpeed),n.HelpButton.html(r.CloseHelpText),n.MainContainer.css("z-index",n.HelpOverlay.css("z-index")+1),n.CloseHelp.css("z-index",n.MainContainer.css("z-index")+1),n.TextLayers.add(n.ImageLayers).filter(".active:visible").length>0&&n.ControlsToolTip.fadeIn(r.FadeSpeed),d.RepositionControlsTooltip()))}),n.PreviewButton.click(function(t){function a(){d.CloseControls(),d.CloseHelp(function(){e.fancybox.showLoading(),e.post(r.APIUrl+"/GetPreviewImage",{authcode:r.AuthCode,guid:i,templatename:n.Canvases.filter(":visible").attr("data-set-name"),imagewidth:r.PreviewImageWidth,previewwatermark:r.UseWatermark,imagequality:r.ImageQuality,imagetype:r.ImageFormat},function(a){var i=d.GetAJAXError(a);""==i?e.fancybox(a.objResult,{type:"image",openSpeed:r.FadeSpeed}):t.preventDefault()},"jsonp").error(function(){t.preventDefault()})})}n.LoadingOverlay.is(":visible")?(e.fancybox.showLoading(),setTimeout(function(){a()},r.LoadInterval)):a()}),n.CloseHelp.click(function(){d.CloseHelp()}),n.ResetButton.click(function(e){e.preventDefault(),confirm("Are you sure you wish to reset this product to it's default settings?")&&(document.cookie="",d.DeletePreview(r.ProductName))}),n.MainContainer.find(".fa, .label").click(function(t){t.preventDefault(),t.stopPropagation(),e(this).parent().click()}),e(document).click(function(t){var a=!0,i=e(t.target);i.parents().index(n.CanvasContainer)>-1&&(a=!1),i.parents().index(n.ButtonPanel)>-1&&(a=!1),i.parents().index(n.Controls)>-1&&(a=!1),i.is(".fa")&&(a=!1),i.is(".label")&&(a=!1),i.is("input[type=file]")&&(a=!1),n.LoadingOverlay.is(":visible")&&(a=!1),e(".fancybox-overlay").is(":visible")&&(a=!1),a&&(d.CloseHelp(),d.CloseControls())})},BindLibraryImageClick:function(t){t.mousedown(function(){var t=e(this),o=n.LibraryImages.filter(".active");n.LoadingOverlay.fadeIn(r.FadeSpeed),n.LibraryImages.removeClass("active"),t.addClass("active"),clearTimeout(a),a=setTimeout(function(){var a=n.Canvases.filter(":visible:first"),s=t.attr("data-url"),l=e("#"+t.attr("data-layer-id")).attr("data-layer-data");e.post(r.APIUrl+"/UpdateLayerInPreview",{authcode:r.AuthCode,guid:i,templatename:a.attr("data-set-name"),layername:t.attr("data-layer-name"),layerdata:s},function(u){e("#"+t.attr("data-layer-id")).attr("data-layer-data",s),n.LoadingOverlay.fadeIn(r.FadeSpeed);var p=d.GetAJAXError(u);""==p?d.LoadPreviewImage(a,i,function(){e("#"+t.attr("data-layer-id")).attr("data-layer-data",l),n.LibraryImages.removeClass("active"),o.addClass("active")}):(e("#"+t.attr("data-layer-id")).attr("data-layer-data",l),n.LibraryImages.removeClass("active"),o.addClass("active"),n.LoadingOverlay.fadeOut(r.FadeSpeed),alert("Layer could not be updated"),e.error(p))},"jsonp").error(function(a,i,s){e("#"+t.attr("data-layer-id")).attr("data-layer-data",l),n.LibraryImages.removeClass("active"),o.addClass("active"),n.LoadingOverlay.fadeOut(r.FadeSpeed),alert(s),e.error(s)})},r.LoadInterval)})},LoadPreviewImage:function(t,a,i){n.LoadingOverlay.fadeIn(r.FadeSpeed);var o=d.GetCurrentDateTime();e.post(r.APIUrl+"/GetPreviewImage",{authcode:r.AuthCode,guid:a,templatename:t.attr("data-set-name"),imagewidth:Math.round(n.CanvasContainer.width()),previewwatermark:r.UseWatermark,imagequality:r.ImageQuality,imagetype:r.ImageFormat},function(s){var l=d.GetAJAXError(s);""==l?(t.find(n.PreviewImages).attr("src",s.objResult),t.find(n.PreviewImages).one("load",function(){if(d.CloseHelp(),n.LoadingOverlay.fadeOut(r.FadeSpeed),r.ResponseTracking){var i=d.GetCurrentDateTime();e.post(r.APIUrl+"/SubmitResponseTime",{start:o,finish:i,authcode:r.AuthCode,method:"GetPreviewImage",guid:a,templatename:t.attr("data-set-name"),imagewidth:t.width(),imagequality:r.ImageQuality,imagetype:r.ImageFormat},function(){},"jsonp")}})):(void 0!=i&&i(),n.LoadingOverlay.fadeOut(r.FadeSpeed),alert("Preview could not be loaded"),e.error(l))},"jsonp").error(function(t,a,o){void 0!=i&&i(),n.LoadingOverlay.fadeOut(r.FadeSpeed),alert(o),e.error(o)})},FormatLibraryImages:function(t){var a=t.length;a>0&&(t.filter(".active"),t.each(function(t){var i=e(this),o=2;i.css({display:"block","float":"left",width:50-o+"%","margin-right":o+"%","box-sizing":"border-box","-moz-box-sizing":"border-box","-webkit-box-sizing":"border-box"}),0==a%2?t>=a-2?i.css("margin-bottom","0"):i.css("margin-bottom",o+"%"):t==a-1?i.css("margin-bottom","0"):i.css("margin-bottom",o+"%")}))},ResizeLibraryContainer:function(){n.LibraryImagesContainer.css({"max-height":n.ImageControls.height()-(n.LibraryImagesContainer.position().top-n.LibraryImagesContainer.parent().position().top)+"px"})},CloseHelp:function(e){n.HelpButton.html(r.HelpButtonText),n.HelpButton.attr("title","Help"),n.ToolTips.fadeOut(r.FadeSpeed),n.HelpOverlay.fadeOut(r.FadeSpeed,function(){n.MainContainer.css("z-index","auto"),void 0!=e&&e()})},CloseControls:function(){1==n.LoadingOverlay.is(":visible")?setTimeout(function(){n.CanvasElements.removeClass("active").css("z-index","1"),n.LibraryImagesContainer.find("."+r.Prefix+"Clear").remove(),n.TextContent.val(""),n.TextContent.attr("data-layer-name",""),n.CharacterCounter.text("").hide().removeClass("limit"),n.TextControls.find(n.ControlsTitles).text(r.TextControlsTitle),n.ImageControls.find(n.ControlsTitles).text(r.ImageControlsTitle),null!=n.UploadImages&&n.UploadImages.remove(),n.LibraryImages.removeClass("active").hide(),n.NoLibraryImages.hide(),n.TextControls.hide(),n.ImageControls.hide(),n.ControlsPlaceholder.show(),null!=n.Dropzone&&n.Dropzone.hide()
},r.DoneTypingInterval):(n.CanvasElements.removeClass("active").css("z-index","1"),n.LibraryImagesContainer.find("."+r.Prefix+"Clear").remove(),n.TextContent.val(""),n.TextContent.attr("data-layer-name",""),n.CharacterCounter.text("").hide().removeClass("limit"),n.TextControls.find(n.ControlsTitles).text(r.TextControlsTitle),n.ImageControls.find(n.ControlsTitles).text(r.ImageControlsTitle),null!=n.UploadImages&&n.UploadImages.remove(),n.LibraryImages.removeClass("active").hide(),n.NoLibraryImages.hide(),n.TextControls.hide(),n.ImageControls.hide(),n.ControlsPlaceholder.show(),null!=n.Dropzone&&n.Dropzone.hide())},GetAJAXError:function(e){return null==e?"Data is null":null==e.objResult?"Data.objResult is null":null!=e.objResult.ErrorMessage?e.objResult.ErrorMessage:""},Error:function(t){n.LoadingOverlay.hide(),n.Personalisation.prepend('<div class="'+r.Prefix+'Error">'+r.GenericError+"</div>"),e.error(t)},GetCSSValue:function(e,t){var a=e.css(t);try{return void 0!=a?a.replace(/[^-\d\.]/g,""):""}catch(i){return""}},RepositionControlsTooltip:function(){var e=n.ControlsTitles.filter(":visible").outerHeight(!0);if(null!==e){var t=parseFloat(d.GetCSSValue(n.Controls,"padding-top"))+e;t-=n.ControlsToolTip.outerHeight(),n.ControlsToolTip.css({"max-width":n.ControlsToolTip.parent().width(),top:t+"px",left:d.GetCSSValue(n.Controls,"padding-left")+"px"})}},RepositionTooltips:function(t,a){t.find(n.ToolTips).each(function(i){var o=t.find(n.ToolTips).eq(i),r=parseFloat(o.attr("data-y")),s=parseFloat(o.attr("data-x"));if(void 0!==a)r*=a,s*=a;else{var l=t.attr("data-scale-factor");void 0!==l&&(r*=l,s*=l)}var u=e("#"+o.attr("data-layer-id"));o.css({"max-width":u.width()}),r-=o.outerHeight(!0),r-=d.GetCSSValue(o,"border-bottom-width"),o.css({left:s,top:r})})},SetCookie:function(e,t,a){if(a){var i=new Date;i.setTime(i.getTime()+1e3*60*60*24*a);var o="; expires="+i.toGMTString()}else var o="";document.cookie=e+"="+t+o+"; path=/"},GetCookie:function(e){for(var t=e+"=",a=document.cookie.split(";"),i=0;i<a.length;i++){for(var o=a[i];" "==o.charAt(0);)o=o.substring(1,o.length);if(0==o.indexOf(t))return o.substring(t.length,o.length)}return null},GetPreviewGuid:function(){return n.PreviewGuidInput.val()},DeleteCookie:function(e){d.SetCookie(e,"",-1)},DeletePreview:function(e){var t=r.Prefix+e.split(" ").join("-");d.DeleteCookie(t),window.location.reload()},GetCurrentDateTime:function(){var e=new Date,t=e.getMilliseconds();return t.toString().length<3&&(t+="0"),t.toString().length<3&&(t+="0"),e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+":"+t},isIE:function(){var e=navigator.userAgent.toLowerCase();return-1!=e.indexOf("msie")||-1!=e.indexOf("trident")?!0:!1},FormatArticle:function(t){var a=["a","e","i","o","u"];return e.inArray(t.toLowerCase().charAt(0),a)>-1?"an":"a"}};e.fn.EmaginationJS=function(t){return d[t]?d[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?(e.error("Method "+method+" does not exist"),void 0):d.init.apply(this,arguments)}}(jQuery);